import { ServiceDependencies } from './api'

export function renderServiceDependenciesToMarkdown({
    serviceDependencies,
    serviceName,
    env,
}: {
    serviceDependencies: ServiceDependencies
    serviceName: string
    env: string
}): string {
    const header = `${iconSVG} <span>Datadog service: ${serviceName}</span> \n---\n\n`
    let table = `${header}| Calls | Called by |\n| --- | ----------- |`

    const called_by = [...serviceDependencies.called_by]
    const calls = [...serviceDependencies.calls]

    if (called_by.length === 0) {
        called_by.push('Not called by any service')
    }
    if (calls.length === 0) {
        calls.push("Doesn't call any service")
    }

    const iterations = Math.max(calls.length, called_by.length)

    for (let index = 0; index < iterations; index++) {
        table += `\n| ${calls[index] ?? ''} | ${called_by[index] ?? ''} |`
    }

    // for (const call of serviceDependencies.calls) {
    //     table += `\n| ${call} |  |`
    // }

    // Link to Datadog service map for the previous day.
    const { start, end } = getStartAndEnd()
    const link = `https://app.datadoghq.com/apm/map?env=${env}&start=${start}&end=${end}&service=${serviceName}`

    table += `\n\n[View full service map on datadog](${link})`

    return table
}

function getStartAndEnd(): { start: number; end: number } {
    const end = Date.now()

    const today = new Date()
    today.setDate(today.getDate() - 1)

    return {
        start: today.getTime(),
        end,
    }
}

const iconSVG =
    '<svg width="16" height="18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="m13.402 12.742-1.425-.985-1.188 2.08-1.383-.423L8.19 15.36l.063.613 6.617-1.278-.384-4.332-1.083 2.379ZM7.23 10.874l1.062-.153c.172.081.291.112.497.167.321.087.693.171 1.243-.12.128-.066.394-.32.502-.466l4.35-.827.444 5.627-7.453 1.407-.645-5.635Zm8.081-2.027-.429.085-.825-8.929L0 1.711l1.732 14.722 1.645-.25c-.131-.197-.336-.434-.685-.739-.485-.422-.313-1.138-.028-1.59.379-.765 2.327-1.736 2.217-2.958-.04-.444-.107-1.022-.5-1.418-.016.164.01.323.01.323s-.16-.216-.241-.511c-.08-.113-.143-.149-.228-.3-.06.175-.053.377-.053.377s-.132-.327-.153-.603c-.079.123-.098.358-.098.358s-.172-.516-.133-.794c-.078-.241-.31-.721-.245-1.812.429.315 1.373.24 1.741-.328.123-.188.206-.702-.06-1.714-.172-.649-.596-1.615-.762-1.982l-.02.015c.088.295.267.915.336 1.215.21.91.265 1.228.167 1.647-.083.365-.283.604-.79.871-.507.268-1.18-.384-1.223-.42-.492-.41-.873-1.081-.916-1.407-.044-.357.196-.57.318-.863a3.037 3.037 0 0 0-.367.145s.23-.25.515-.467c.118-.082.187-.134.311-.242-.18-.003-.325.003-.325.003s.3-.17.61-.294c-.227-.01-.445-.001-.445-.001S3 2.38 3.528 2.15c.363-.156.718-.11.917.192.262.396.537.61 1.12.744.358-.166.467-.251.916-.38.396-.456.707-.515.707-.515s-.154.148-.196.381c.225-.185.47-.34.47-.34s-.094.124-.183.32l.02.031c.262-.164.57-.294.57-.294s-.088.117-.191.267a8.75 8.75 0 0 1 .753.028c.917.02 1.108-1.027 1.46-1.158.44-.165.637-.265 1.389.508.644.664 1.148 1.852.898 2.118-.21.22-.623-.087-1.082-.685a2.648 2.648 0 0 1-.51-1.168 1.153 1.153 0 0 0-.355-.635s.164.38.164.717c0 .184.021.871.303 1.257-.028.056-.041.279-.072.321-.327-.414-1.03-.71-1.144-.798.387.333 1.279 1.098 1.621 1.83.324.694.133 1.329.297 1.493.047.048.696.896.821 1.322.218.743.013 1.523-.272 2.007l-.797.13c-.116-.034-.195-.05-.3-.114.058-.107.172-.373.174-.428l-.045-.083c-.248.368-.664.725-1.01.93-.45.269-.972.228-1.31.118-.963-.311-1.873-.992-2.092-1.171 0 0-.007.143.035.175a7.55 7.55 0 0 0 1.335 1.166l-1.145.132.541 4.416c-.24.037-.277.054-.54.093-.231-.857-.674-1.416-1.159-1.742-.427-.288-1.016-.353-1.58-.236l-.036.044c.392-.043.855.017 1.33.332.467.31.843 1.108.982 1.588.177.614.3 1.272-.178 1.968-.34.495-1.33.769-2.13.177.214.36.503.655.892.71.577.082 1.125-.023 1.503-.429.322-.347.493-1.072.448-1.836l.51-.078.184 1.372L16 15.882l-.689-7.035Zm-5.134-3.725c-.024.056-.06.093-.005.277l.003.01.01.024.022.055c.1.214.21.417.394.52.048-.009.097-.014.148-.017.173-.008.282.02.35.06a.818.818 0 0 0 .005-.167c-.014-.271.051-.734-.447-.977-.189-.091-.453-.063-.54.051.015.002.03.006.04.01.134.048.044.096.02.154Zm1.397 2.536c-.065-.038-.37-.023-.585.004-.41.05-.852.199-.948.278-.176.143-.096.391.034.493.364.285.684.477 1.021.43.207-.028.39-.372.52-.684.088-.214.088-.446-.042-.521Zm-3.622-2.2c.115-.114-.575-.265-1.11.117-.396.283-.408.888-.03 1.23a.89.89 0 0 0 .098.078 3.274 3.274 0 0 1 .996-.308c.08-.093.173-.258.15-.556-.032-.405-.325-.341-.104-.56Z" fill="#343A4D"/></svg>'
